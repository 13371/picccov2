// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 枚举类型 ====================

enum UserRole {
  USER
  ADMIN
}

enum FolderKind {
  NOTES
  URLS
}

enum ItemType {
  NOTE
  URL
}

enum MessageTarget {
  ALL
  PARTIAL
}

// ==================== 用户模型 ====================

model User {
  id                  String    @id @default(uuid())
  email               String    @unique
  role                UserRole  @default(USER)
  privatePasswordHash String? // 隐私二级密码哈希
  lastActiveAt        DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // 关系
  folders  Folder[]
  items    Item[]
  messages UserMessage[]

  @@index([email])
  @@map("users")
}

// ==================== 文件夹模型 ====================

model Folder {
  id        String     @id @default(uuid())
  name      String
  kind      FolderKind // NOTES 或 URLS
  isPrivate Boolean    @default(false) // 仅 NOTES 可为 true
  isStarred Boolean    @default(false)
  userId    String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // 关系
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  items Item[]

  @@unique([userId, kind, name])
  @@index([userId])
  @@index([userId, kind])
  @@index([userId, isPrivate])
  @@map("folders")
}

// ==================== 统一项目模型（NOTE 和 URL 共用）====================

model Item {
  id        String    @id @default(uuid())
  type      ItemType // NOTE 或 URL
  title     String?   @db.VarChar(10) // 最多 10 字，允许为空
  content   String? // NOTE 类型使用（文本内容）
  url       String? // URL 类型使用（网址）
  folderId  String? // 可为空，表示"未分类"
  userId    String
  isStarred Boolean   @default(false)
  deletedAt DateTime? // 软删除时间戳（tombstone）
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt // 用于同步排序

  // 关系
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder Folder? @relation(fields: [folderId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, deletedAt]) // 查询时排除已删除
  @@index([userId, type]) // 按类型查询
  @@index([userId, folderId]) // 按文件夹查询
  @@index([userId, updatedAt]) // 按更新时间排序（同步）
  @@index([folderId])
  @@map("items")
}

// ==================== 系统消息模型 ====================

model SystemMessage {
  id        String        @id @default(uuid())
  content   String
  target    MessageTarget @default(ALL) // ALL 或 PARTIAL
  createdAt DateTime      @default(now())

  // 关系
  recipients UserMessage[]

  @@index([createdAt])
  @@map("system_messages")
}

// ==================== 用户消息关联表 ====================

model UserMessage {
  userId    String
  messageId String
  readAt    DateTime?

  // 关系
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  message SystemMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@id([userId, messageId])
  @@index([userId])
  @@index([messageId])
  @@map("user_messages")
}
